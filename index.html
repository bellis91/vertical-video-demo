<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Flowplayer / Vertical 9:16 (Optimized)</title>

    <!-- Flowplayer core -->
    <link rel="stylesheet" href="https://cdn.flowplayer.com/releases/native/3/stable/style/flowplayer.css" />
    <script src="https://cdn.flowplayer.com/releases/native/3/stable/flowplayer.min.js"></script>
    <script src="https://cdn.flowplayer.com/releases/native/3/stable/plugins/hls.min.js"></script>
    <!-- Quality selection plugin -->
    <script src="https://cdn.flowplayer.com/releases/native/3/stable/plugins/qsel.min.js"></script>

    <script>
      // Reuse existing values from your original page
      const primarySrc = "https://cdn3.wowza.com/1/YmtuRDkxZnZUVnM1/N21rd2lr/hls/live/playlist.m3u8";
      const token = "eyJraWQiOiIwWE44RnRTYkQxblYiLCJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJjIjoie1wiYWNsXCI6MzgsXCJpZFwiOlwiMFhOOEZ0U2JEMW5WXCJ9IiwiaXNzIjoiRmxvd3BsYXllciJ9.wHlyQZ86rIHD8ldgnpiWbmFBmR4zt_3FSj78GMk7lfQ1es7K8y0MuHzbqcJfp0lm6LcUbUkQ5PsazIsAybxivg";
    </script>

    <style>
      :root {
        --focus-x: 50%;
      }
      html, body {
        margin: 0;
        padding: 0;
        background: #0b0c0d;
        color: #eaeaea;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      }
      .viewport {
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 12px;
        gap: 12px;
      }
      #player {
        background: #000;
        aspect-ratio: 9 / 16;
        height: min(100vh - 120px, 1920px);
        max-height: 1920px;
        max-width: 1080px;
        width: auto;
        margin: 0 auto;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
      }
      /* Fill vertically (client-side crop when source is 16:9) */
      #player video {
        object-fit: cover !important;
        object-position: var(--focus-x) 50% !important;
        background: #000;
      }
      .controls {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #111518;
        padding: 10px 12px;
        border-radius: 10px;
        max-width: 1080px;
        margin: 0 auto;
        font-size: 14px;
      }
      .controls label { opacity: .85; }
      .chip {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        background: #1e2329;
        font-variant-numeric: tabular-nums;
      }
      .debug {
        position: absolute;
        left: 8px;
        bottom: 8px;
        background: rgba(0,0,0,.55);
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 12px;
        line-height: 1.2;
      }
    </style>
  </head>
  <body>
    <div class="viewport">
      <div id="player"></div>

      <div class="controls">
        <span>Focus:</span>
        <label for="focusX">Left</label>
        <input id="focusX" type="range" min="0" max="100" value="50" />
        <label for="focusX">Right</label>
        <span class="chip" id="chipOrient">—</span>
        <span class="chip" id="chipRes">—</span>
      </div>
    </div>

    <script>
      function updateOrientationChip() {
        const chip = document.getElementById('chipOrient');
        chip.textContent = window.matchMedia("(orientation: portrait)").matches ? "Portrait" : "Landscape";
      }
      const player = flowplayer("#player", {
        token,
        src: { type: "application/x-mpegurl", src: primarySrc }
        // muted: true, autoplay: true
      });
      const debug = document.createElement('div');
      debug.className = 'debug';
      debug.id = 'dbg';
      debug.textContent = 'loading…';
      document.querySelector('#player').appendChild(debug);
      function updateDebug() {
        const v = document.querySelector('#player video');
        if (!v) return;
        const w = v.videoWidth || 0;
        const h = v.videoHeight || 0;
        const por = window.matchMedia("(orientation: portrait)").matches ? "P" : "L";
        document.getElementById('chipRes').textContent = w && h ? `${w}×${h}` : '—';
        debug.textContent = `intrinsic: ${w}×${h} | orient: ${por}`;
      }
      function preferPortraitLevel() {
        try {
          const eng = player.engine;
          const hls = eng && eng.hls;
          if (!hls || !Array.isArray(hls.levels)) return;
          const isPortrait = window.matchMedia("(orientation: portrait)").matches;
          if (!isPortrait) return;
          const portraitLevels = hls.levels
            .map((l, i) => ({i, w: l.width, h: l.height, bitrate: l.bitrate}))
            .filter(l => l.h > l.w);
          if (portraitLevels.length) {
            const best = portraitLevels.sort((a,b) => b.h - a.h)[0];
            hls.startLevel = best.i;
            hls.currentLevel = best.i;
          }
        } catch(e) { console.warn('portrait level select error', e); }
      }
      player.on('ready', () => {
        updateOrientationChip();
        preferPortraitLevel();
        setTimeout(updateDebug, 100);
      });
      player.on('playing', updateDebug);
      window.addEventListener('resize', () => {
        updateOrientationChip(); updateDebug(); preferPortraitLevel();
      });
      window.addEventListener('orientationchange', () => {
        updateOrientationChip(); preferPortraitLevel();
      });
      document.getElementById('focusX').addEventListener('input', (e) => {
        document.documentElement.style.setProperty('--focus-x', e.target.value + '%');
      });
    </script>
  </body>
</html>
